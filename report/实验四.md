> **学院：省级示范性软件学院**
>
> **题目：** 《 实验四：Logstash 操作》
>
> **姓名：潘文宝**
>
> **学号：** 2200770201
>
> **班级：** 软工2203
>
> **日期：** 2024-11-8
>
> **实验环境：**  Debian12 + Docker + Elasticsearch-8.15.3 + ELK

# 一、实验目的

学习 Logstash 对日志和数据的转换、传输。

# 二、实验内容

## （1）tomcat 日志处理

### 导入数据

在 kibana 中导入数据

![](images/4-1.png)

这是我的配置：

```conf
input {
    file {
        path => "/usr/share/logstash/pipeline/tomcat_logs/*.txt"
        start_position => "beginning"
        sincedb_path => "/dev/null"
    }
}

filter {
  grok {
    match => { "message" => "%{IPV6:client} - - \[%{HTTPDATE:timestamp}\] \"%{WORD:method} %{URIPATH:request} HTTP/%{NUMBER:http_version}\" %{NUMBER:response} (?:%{NUMBER:bytes}|-)" }
  }
  date {
    match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss Z"]
    target => "@timestamp"
  }
}

output {
    elasticsearch {
        hosts => ["elastic-search:9200"]
        index => "tomcat_logs" 
    }
    stdout {
        codec => rubydebug
    }
}
```

**导入结果：**

![Kibana验证](images/4-1-kibana.png)

### 日志分析

题目：

1. 一个月内，服务器返回的 500 内部服务器错误的比例？

2. 统计 HTTP 状态码出现的次数

```json
GET tomcat_logs/_search
{
  "size": 0,
  "aggs": {
    "status_code_counts": {
      "terms": {
        "field": "response.keyword"
      }
    }
  }
}
```

结果

```json
{
  "took": 42,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 3000,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  },
  "aggregations": {
    "status_code_counts": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "500",
          "doc_count": 781
        },
        {
          "key": "200",
          "doc_count": 749
        },
        {
          "key": "404",
          "doc_count": 738
        },
        {
          "key": "302",
          "doc_count": 732
        }
      ]
    }
  }
}
```

3. 请求中的 Host 分布

```json
GET tomcat_logs/_search
{
  "size": 0,
  "aggs": {
    "host_distribution": {
      "terms": {
        "field": "host.name.keyword"
      }
    }
  }
}
```

结果

```json
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 3000,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  },
  "aggregations": {
    "host_distribution": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "8e5f6c170c95",
          "doc_count": 3000
        }
      ]
    }
  }
}
```

4. 统计接口访问数量分布情况

```json
GET tomcat_logs/_search
{
  "size": 0,
  "aggs": {
    "interface_access_counts": {
      "terms": {
        "field": "request.keyword"
      }
    }
  }
}
```

结果

```json
{
  "took": 5,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 3000,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  },
  "aggregations": {
    "interface_access_counts": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 1664,
      "buckets": [
        {
          "key": "/demo1/",
          "doc_count": 153
        },
        {
          "key": "/examples/jsp/images/execute.gif",
          "doc_count": 141
        },
        {
          "key": "/static/js/app.js",
          "doc_count": 139
        },
        {
          "key": "/about",
          "doc_count": 137
        },
        {
          "key": "/static/css/style.css",
          "doc_count": 134
        },
        {
          "key": "/demo/",
          "doc_count": 133
        },
        {
          "key": "/blog/post/2",
          "doc_count": 127
        },
        {
          "key": "/demo/hello",
          "doc_count": 127
        },
        {
          "key": "/examples/jsp/images/return.gif",
          "doc_count": 124
        },
        {
          "key": "/blog/post/3",
          "doc_count": 121
        }
      ]
    }
  }
}
```

5. Http Version 请求分布情况

```json
GET tomcat_logs/_search
{
  "size": 0,
  "aggs": {
    "http_version_distribution": {
      "terms": {
        "field": "http_version.keyword"
      }
    }
  }
}
```

结果

```json
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 3000,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  },
  "aggregations": {
    "http_version_distribution": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "1.1",
          "doc_count": 3000
        }
      ]
    }
  }
}
```

# 三、问题及解决办法

## 1. 导入不成功

**出现的原因：** 

`logstash` 命令需要绝对路径，配置文件（包括其内容）都需要修改为绝对路径，再次执行则成功导入！