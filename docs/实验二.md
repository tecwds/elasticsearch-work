# 第二次实验

> **学院：省级示范性软件学院**
>
> **题目：** 《 实验二：索引&文档操作》
>
> **姓名：潘文宝**
>
> **学号：** 2200770201
>
> **班级：** 软工2203
>
> **日期：** 2024-09-14
>
> **实验环境：**  Deepin23 + Docker + Elasticsearch-8.15.2 + Apifox

‍

# 一、实验目的

1. 掌握 `Elasticsearch`​ 安装IK分词器安装方法
2. 掌握 `Elasticsearch`​ 索引操作方法
3. 掌握 `Elasticsearch`​ 文档操作训练
4. ​`Elasticsearch`​ 高级查询与DSL训练

# 二、实验内容

## 前置说明

我在 `Apifox`​ 设置了环境变量，执行接口时会自动添加地址前缀，因此后续展示代码不包含地址。

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929190734.png)​

## `Elasticsearch`​ 安装IK分词器

#### 安装分词器

由于我更换了环境，安装 `IK分词器`​ 多了一个步骤

‍

进入 `Docker`​ 容器内部：

```shell
# 我的容器名称是 elastic-work
docker exec -it elastic-work bash
```

安装 `IK分词器`​：

```shell
bin/elasticsearch-plugin install https://get.infini.cloud/elasticsearch/analysis-ik/8.15.2
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929183816.png)​

#### 尝试分词器

1. **最小切分** **​`ik_smart`​**​

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929210743.png)​

2. **最细切分** **​`ik_max_word`​**

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929211041.png)​

## `Elasticsearch`​ 索引操作训练

> 要求：能够根据字段描述，创建索引，修改索引，删除索引
>
> 任务一：
>
> 1. 创建索引
> 2. 修改索引
> 3. 删除索引
> 4. 查看所有

### 用户信息 (User Information) 索引

#### **创建索引**

```json
PUT /user_information
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "user_id": {
        "type": "keyword"
      },
      "name": {
        "type": "text"
      },
      "email": {
        "type": "keyword"
      },
      "date_of_birth": {
        "type": "date"
      },
      "gender": {
        "type": "keyword"
      },
      "address": {
        "type": "text"
      },
      "phone_number": {
        "type": "keyword"
      },
      "registration_date": {
        "type": "date"
      },
      "last_login": {
        "type": "date"
      },
      "status": {
        "type": "keyword"
      }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929192756.png)​

#### **查看索引**

```http
GET /user_information
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929192828.png)​

#### **删除索引**

```http
DELETE /user_information

# 删除后重新执行了创建索引
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929192839.png)​

#### **修改索引**

```json
PUT /user_information/_mapping
{
    "properties": {
        "avator": {
            "type": "text"
        },
        "login_date": {
            "type": "integer"
        }
    }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929192931.png)​

### 产品目录 (Product Catalog) 索引

#### **创建索引**

```json
PUT /product_catalog
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "product_id": {
        "type": "keyword"
      },
      "name": {
        "type": "text"
      },
      "description": {
        "type": "text"
      },
      "category": {
        "type": "keyword"
      },
      "price": {
        "type": "double"
      },
      "stock_quantity": {
        "type": "integer"
      },
      "supplier": {
        "type": "keyword"
      },
      "release_date": {
        "type": "date"
      },
      "tags": {
        "type": "keyword"
      },
      "rating": {
        "type": "float"
      }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929202830.png)​

#### **查看索引**

```json
GET /product_catalog
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929202854.png)​

#### **删除索引**

```http
DELETE /product_catalog
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929203043.png)​

#### **修改索引**

```json
PUT /product_catalog/_mapping
{
    "properties": {
        "buy_limit": {
            "type": "integer"
        }
    }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929203129.png)​

### 订单记录 (Order Records) 索引字段描述

#### **创建索引**

```json
PUT /order_records
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "order_id": {
        "type": "keyword"
      },
      "customer_id": {
        "type": "keyword"
      },
      "order_date": {
        "type": "date"
      },
      "status": {
        "type": "keyword"
      },
      "total_amount": {
        "type": "double"
      },
      "items": {
		"type": "nested",
        "properties": {
          "product_id": {
            "type": "keyword"
          },
          "quantity": {
            "type": "integer"
          },
          "price": {
            "type": "double"
          }
        }
      },
      "shipping_address": {
        "type": "text"
      },
      "payment_method": {
        "type": "keyword"
      },
      "shipping_date": {
        "type": "date"
      },
      "delivery_date": {
        "type": "date"
      }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929203145.png)​

#### **查看索引**

```http
GET /order_records
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929203209.png)​

#### **删除索引**

```http
DELETE /order_records
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929203338.png)​

#### **修改索引**

```http
PUT /order_records/_mapping
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/image-20240929203229-mmc950q.png)​

## `Elasticsearch`​ 文档操作训练

> 要求：文档的CRUD练习
>
> 任务二：
>
> 1. 创建文档
> 2. 修改文档(自己设计，修改要合理）
> 3. 删除文档
> 4. 查看文档
> 5. 将下面的Json数据批量导入ES数据库中

### 用户信息数据

#### 创建文档

```json
POST /user_information/_doc/2200770201
{
  "user_id": "2200770201",
  "name": "潘文宝",
  "email": "tecwds@163.com",
  "date_of_birth": "1800-09-09",
  "gender": "沃尔玛购物袋",
  "address": "中国贵州贵阳贵州大学",
  "phone_number": "12312341234",
  "registration_date": "2023-04-01T08:00:00Z",
  "last_login": "2024-09-29T12:00:00Z",
  "status": "active"
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929213342.png)​

#### 修改文档

```json
POST /user_information/_update/2200770201
{
  "doc": {
    "gender": "武装直升机"
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929213446.png)​

#### 删除文档

```http
DELETE /user_information/_doc/2200770201
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929213554.png)​

#### 查看文档

```http
GET /user_information/_doc/2200770201
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929213530.png)​

#### 批量导入

```json
POST /_bulk
{ "index": { "_index": "user_information", "_id": "001" } }
{ "user_id": "001", "name": "Alice Johnson", "email": "alice.johnson@example.com", "date_of_birth": "1990-05-15", "gender": "female", "address": "123 Main St, Anytown, USA", "phone_number": "123-456-7890", "registration_date": "2023-01-15", "last_login": "2024-09-01", "status": "active" }
{ "index": { "_index": "user_information", "_id": "002" } }
{ "user_id": "002", "name": "Bob Smith", "email": "bob.smith@example.com", "date_of_birth": "1985-08-20", "gender": "male", "address": "456 Elm St, Othertown, USA", "phone_number": "234-567-8901", "registration_date": "2023-02-20", "last_login": "2024-08-25", "status": "active" }
{ "index": { "_index": "user_information", "_id": "003" } }
{ "user_id": "003", "name": "Charlie Brown", "email": "charlie.brown@example.com", "date_of_birth": "1992-11-30", "gender": "male", "address": "789 Maple Ave, Sometown, USA", "phone_number": "345-678-9012", "registration_date": "2023-03-10", "last_login": "2024-09-05", "status": "inactive" }
{ "index": { "_index": "user_information", "_id": "004" } }
{ "user_id": "004", "name": "David Wilson", "email": "david.wilson@example.com", "date_of_birth": "1988-02-14", "gender": "male", "address": "101 Oak St, Anycity, USA", "phone_number": "456-789-0123", "registration_date": "2023-04-05", "last_login": "2024-08-30", "status": "active" }
{ "index": { "_index": "user_information", "_id": "005" } }
{ "user_id": "005", "name": "Eve Davis", "email": "eve.davis@example.com", "date_of_birth": "1995-07-22", "gender": "female", "address": "202 Pine St, Otherville, USA", "phone_number": "567-890-1234", "registration_date": "2023-05-18", "last_login": "2024-09-02", "status": "active" }
{ "index": { "_index": "user_information", "_id": "006" } }
{ "user_id": "006", "name": "Frank Miller", "email": "frank.miller@example.com", "date_of_birth": "1991-10-05", "gender": "male", "address": "303 Cedar Rd, Newtown, USA", "phone_number": "678-901-2345", "registration_date": "2023-06-22", "last_login": "2024-09-03", "status": "active" }
{ "index": { "_index": "user_information", "_id": "007" } }
{ "user_id": "007", "name": "Grace Lee", "email": "grace.lee@example.com", "date_of_birth": "1989-04-17", "gender": "female", "address": "404 Birch Ln, Oldtown, USA", "phone_number": "789-012-3456", "registration_date": "2023-07-30", "last_login": "2024-09-04", "status": "inactive" }
{ "index": { "_index": "user_information", "_id": "008" } }
{ "user_id": "008", "name": "Hannah White", "email": "hannah.white@example.com", "date_of_birth": "1993-12-25", "gender": "female", "address": "505 Spruce St, Littletown, USA", "phone_number": "890-123-4567", "registration_date": "2023-08-15", "last_login": "2024-09-06", "status": "active" }
{ "index": { "_index": "user_information", "_id": "009" } }
{ "user_id": "009", "name": "Ivy Green", "email": "ivy.green@example.com", "date_of_birth": "1994-03-03", "gender": "female", "address": "606 Willow Ave, Bigcity, USA", "phone_number": "901-234-5678", "registration_date": "2023-09-01", "last_login": "2024-09-07", "status": "active" }
{ "index": { "_index": "user_information", "_id": "010" } }
{ "user_id": "010", "name": "Jack Black", "email": "jack.black@example.com", "date_of_birth": "1987-06-18", "gender": "male", "address": "707 Poplar Dr, Smalltown, USA", "phone_number": "012-345-6789", "registration_date": "2023-10-10", "last_login": "2024-09-08", "status": "inactive" }
{ "index": { "_index": "user_information", "_id": "011" } }
{ "user_id": "011", "name": "Karen Adams", "email": "karen.adams@example.com", "date_of_birth": "1990-09-21", "gender": "female", "address": "808 Chestnut Blvd, Metropolis, USA", "phone_number": "123-456-7890", "registration_date": "2023-11-25", "last_login": "2024-09-09", "status": "active" }
{ "index": { "_index": "user_information", "_id": "012" } }
{ "user_id": "012", "name": "Leo King", "email": "leo.king@example.com", "date_of_birth": "1986-01-12", "gender": "male", "address": "909 Ash Ct, Villagetown, USA", "phone_number": "234-567-8901", "registration_date": "2023-12-05", "last_login": "2024-09-10", "status": "active" }
{ "index": { "_index": "user_information", "_id": "013" } }
{ "user_id": "013", "name": "Mia Moore", "email": "mia.moore@example.com", "date_of_birth": "1992-02-28", "gender": "female", "address": "1010 Fir Ln, Hamlet, USA", "phone_number": "345-678-9012", "registration_date": "2024-01-10", "last_login": "2024-09-11", "status": "inactive" }
{ "index": { "_index": "user_information", "_id": "014" } }
{ "user_id": "014", "name": "Nina Scott", "email": "nina.scott@example.com", "date_of_birth": "1988-05-05", "gender": "female", "address": "1111 Cypress St, Township, USA", "phone_number": "456-789-0123", "registration_date": "2024-02-14", "last_login": "2024-09-12", "status": "active" }
{ "index": { "_index": "user_information", "_id": "015" } }
{ "user_id": "015", "name": "Oscar Turner", "email": "oscar.turner@example.com", "date_of_birth": "1991-07-19", "gender": "male", "address": "1212 Redwood Rd, Cityville, USA", "phone_number": "567-890-1234", "registration_date": "2024-03-20", "last_login": "2024-09-13", "status": "active" }
{ "index": { "_index": "user_information", "_id": "016" } }
{ "user_id": "016", "name": "Paul Walker", "email": "paul.walker@example.com", "date_of_birth": "1989-10-10", "gender": "male", "address": "1313 Cherry Ave, Urbantown, USA", "phone_number": "678-901-2345", "registration_date": "2024-04-25", "last_login": "2024-09-14", "status": "inactive" }
{ "index": { "_index": "user_information", "_id": "017" } }
{ "user_id": "017", "name": "Quinn Hughes", "email": "quinn.hughes@example.com", "date_of_birth": "1993-11-11", "gender": "male", "address": "1414 Beech St, Suburbia, USA", "phone_number": "789-012-3456", "registration_date": "2024-05-30", "last_login": "2024-09-15", "status": "active" }
{ "index": { "_index": "user_information", "_id": "018" } }
{ "user_id": "018", "name": "Rose Hall", "email": "rose.hall@example.com", "date_of_birth": "1990-03-22", "gender": "female", "address": "1515 Palm Dr, Downtown, USA", "phone_number": "890-123-4567", "registration_date": "2024-06-15", "last_login": "2024-09-16", "status": "active" }
{ "index": { "_index": "user_information", "_id": "019" } }
{ "user_id": "019", "name": "Steve Young", "email": "steve.young@example.com", "date_of_birth": "1987-09-09", "gender": "male", "address": "1616 Pine St, Uptown, USA", "phone_number": "901-234-5678", "registration_date": "2024-07-20", "last_login": "2024-09-17", "status": "inactive" }
{ "index": { "_index": "user_information", "_id": "020" } }
{ "user_id": "020", "name": "Tina Brown", "email": "tina.brown@example.com", "date_of_birth": "1994-12-12", "gender": "female", "address": "1717 Maple Ave, Seaside, USA", "phone_number": "012-345-6789", "registration_date": "2024-08-10", "last_login": "2024-09-18", "status": "active" }

```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929213811.png)​

### 产品目录数据

#### 创建文档

```json
POST /product_catalog/_doc/123123
{
  "product_id": "P123456",
  "name": "Elasticsearch入门指南",
  "description": "仅需1999,这本书带回家",
  "category": "书籍",
  "price": 1999,
  "stock_quantity": 100,
  "supplier": "技术出版社",
  "release_date": "2023-01-01",
  "tags": ["Elasticsearch", "教程", "入门"],
  "rating": 4.5
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929214051.png)​

#### 修改文档

```json
POST /product_catalog/_update/123123
{
  "doc": {
    "price":  2999
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929214308.png)​

#### 删除文档

```json
DELETE /product_catalog/_doc/123123
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929214436.png)​

#### 查看文档

```json
GET /product_catalog/_doc/123123
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929214550.png)​

#### 批量导入

```json
POST /_bulk
{ "index": { "_index": "product_catalog", "_id": "P001" } }
{ "product_id": "P001", "name": "Wireless Mouse", "description": "A high precision wireless mouse with ergonomic design.", "category": "Electronics", "price": 29.99, "stock_quantity": 150, "supplier": "TechCorp", "release_date": "2023-01-15", "tags": ["wireless", "mouse", "electronics"], "rating": 4.5 }
{ "index": { "_index": "product_catalog", "_id": "P002" } }
{ "product_id": "P002", "name": "Bluetooth Speaker", "description": "Portable Bluetooth speaker with excellent sound quality.", "category": "Audio", "price": 49.99, "stock_quantity": 200, "supplier": "SoundWave", "release_date": "2023-02-20", "tags": ["bluetooth", "speaker", "audio"], "rating": 4.7 }
{ "index": { "_index": "product_catalog", "_id": "P003" } }
{ "product_id": "P003", "name": "Smartphone Stand", "description": "Adjustable smartphone stand for hands-free viewing.", "category": "Accessories", "price": 15.99, "stock_quantity": 300, "supplier": "GadgetPlus", "release_date": "2023-03-10", "tags": ["smartphone", "stand", "accessories"], "rating": 4.3 }
{ "index": { "_index": "product_catalog", "_id": "P004" } }
{ "product_id": "P004", "name": "USB-C Charger", "description": "Fast charging USB-C charger compatible with most devices.", "category": "Chargers", "price": 19.99, "stock_quantity": 250, "supplier": "ChargeMaster", "release_date": "2023-04-05", "tags": ["usb-c", "charger", "electronics"], "rating": 4.6 }
{ "index": { "_index": "product_catalog", "_id": "P005" } }
{ "product_id": "P005", "name": "Noise Cancelling Headphones", "description": "Over-ear headphones with active noise cancellation.", "category": "Audio", "price": 89.99, "stock_quantity": 100, "supplier": "AudioTech", "release_date": "2023-05-18", "tags": ["noise cancelling", "headphones", "audio"], "rating": 4.8 }
{ "index": { "_index": "product_catalog", "_id": "P006" } }
{ "product_id": "P006", "name": "4K Monitor", "description": "Ultra HD 4K monitor with stunning display quality.", "category": "Monitors", "price": 299.99, "stock_quantity": 80, "supplier": "ViewPerfect", "release_date": "2023-06-22", "tags": ["4k", "monitor", "electronics"], "rating": 4.9 }
{ "index": { "_index": "product_catalog", "_id": "P007" } }
{ "product_id": "P007", "name": "Gaming Keyboard", "description": "Mechanical keyboard with customizable RGB lighting.", "category": "Gaming", "price": 59.99, "stock_quantity": 120, "supplier": "GameGear", "release_date": "2023-07-30", "tags": ["gaming", "keyboard", "electronics"], "rating": 4.4 }
{ "index": { "_index": "product_catalog", "_id": "P008" } }
{ "product_id": "P008", "name": "Fitness Tracker", "description": "Smart fitness tracker with heart rate monitor.", "category": "Wearables", "price": 39.99, "stock_quantity": 180, "supplier": "FitLife", "release_date": "2023-08-15", "tags": ["fitness", "tracker", "wearables"], "rating": 4.2 }
{ "index": { "_index": "product_catalog", "_id": "P009" } }
{ "product_id": "P009", "name": "Electric Toothbrush", "description": "Rechargeable electric toothbrush with multiple modes.", "category": "Personal Care", "price": 34.99, "stock_quantity": 140, "supplier": "SmileBright", "release_date": "2023-09-01", "tags": ["electric", "toothbrush", "personal care"], "rating": 4.5 }
{ "index": { "_index": "product_catalog", "_id": "P010" } }
{ "product_id": "P010", "name": "Smart Thermostat", "description": "Wi-Fi enabled smart thermostat with energy saving features.", "category": "Home Automation", "price": 129.99, "stock_quantity": 90, "supplier": "HomeSmart", "release_date": "2023-10-10", "tags": ["smart", "thermostat", "home automation"], "rating": 4.7 }
{ "index": { "_index": "product_catalog", "_id": "P011" } }
{ "product_id": "P011", "name": "LED Desk Lamp", "description": "Adjustable LED desk lamp with touch control.", "category": "Lighting", "price": 24.99, "stock_quantity": 160, "supplier": "BrightLight", "release_date": "2023-11-25", "tags": ["led", "desk lamp", "lighting"], "rating": 4.3 }
{ "index": { "_index": "product_catalog", "_id": "P012" } }
{ "product_id": "P012", "name": "Portable Hard Drive", "description": "1TB portable hard drive with fast data transfer.", "category": "Storage", "price": 64.99, "stock_quantity": 110, "supplier": "DataSafe", "release_date": "2023-12-05", "tags": ["portable", "hard drive", "storage"], "rating": 4.6 }
{ "index": { "_index": "product_catalog", "_id": "P013" } }
{ "product_id": "P013", "name": "Coffee Maker", "description": "Automatic coffee maker with programmable settings.", "category": "Kitchen Appliances", "price": 79.99, "stock_quantity": 130, "supplier": "BrewMaster", "release_date": "2024-01-10", "tags": ["coffee", "maker", "appliances"], "rating": 4.4 }
{ "index": { "_index": "product_catalog", "_id": "P014" } }
{ "product_id": "P014", "name": "Smart Light Bulb", "description": "Color changing smart light bulb with app control.", "category": "Lighting", "price": 14.99, "stock_quantity": 220, "supplier": "LightSmart", "release_date": "2024-02-14", "tags": ["smart", "light bulb", "lighting"], "rating": 4.2 }
{ "index": { "_index": "product_catalog", "_id": "P015" } }
{ "product_id": "P015", "name": "Electric Kettle", "description": "Quick boil electric kettle with auto shut-off.", "category": "Kitchen Appliances", "price": 29.99, "stock_quantity": 170, "supplier": "QuickBoil", "release_date": "2024-03-20", "tags": ["electric", "kettle", "appliances"], "rating": 4.5 }
{ "index": { "_index": "product_catalog", "_id": "P016" } }
{ "product_id": "P016", "name": "Robot Vacuum", "description": "Smart robot vacuum cleaner with scheduling features.", "category": "Home Appliances", "price": 199.99, "stock_quantity": 60, "supplier": "CleanBot", "release_date": "2024-04-25", "tags": ["robot", "vacuum", "home appliances"], "rating": 4.8 }
{ "index": { "_index": "product_catalog", "_id": "P017" } }
{ "product_id": "P017", "name": "Digital Camera", "description": "Compact digital camera with high resolution.", "category": "Photography", "price": 149.99, "stock_quantity": 95, "supplier": "PhotoSnap", "release_date": "2024-05-30", "tags": ["digital", "camera", "photography"], "rating": 4.7 }
{ "index": { "_index": "product_catalog", "_id": "P018" } }
{ "product_id": "P018", "name": "Smartwatch", "description": "Feature-rich smartwatch with fitness tracking.", "category": "Wearables", "price": 99.99, "stock_quantity": 140, "supplier": "WristTech", "release_date": "2024-06-15", "tags": ["smartwatch", "wearables", "fitness"], "rating": 4.4 }
{ "index": { "_index": "product_catalog", "_id": "P019" } }
{ "product_id": "P019", "name": "Air Fryer", "description": "Healthier cooking with a digital air fryer.", "category": "Kitchen Appliances", "price": 89.99, "stock_quantity": 115, "supplier": "HealthyCook", "release_date": "2024-07-20", "tags": ["air fryer", "kitchen", "appliances"], "rating": 4.6 }
{ "index": { "_index": "product_catalog", "_id": "P020" } }
{ "product_id": "P020", "name": "Electric Scooter", "description": "Eco-friendly electric scooter with long battery life.", "category": "Transportation", "price": 299.99, "stock_quantity": 50, "supplier": "EcoRide", "release_date": "2024-08-10", "tags": ["electric", "scooter", "transportation"], "rating": 4.7 }

```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929214643.png)​

### 订单记录数据

#### 创建文档

```json
POST /order_records/_doc/123
{
  "order_id": "O123456789",
  "customer_id": "C123456",
  "order_date": "2023-10-15T08:00:00Z",
  "status": "pending",
  "total_amount": 299.99,
  "items": [
    {
      "product_id": "P12345",
      "quantity": 2,
      "price": 99.99
    },
    {
      "product_id": "P67890",
      "quantity": 1,
      "price": 100.00
    }
  ],
  "shipping_address": "123 Main St, Anytown, AN 12345",
  "payment_method": "credit_card",
  "shipping_date": "2023-10-16T08:00:00Z",
  "delivery_date": "2023-10-20T08:00:00Z"
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929214901.png)​

#### 修改文档

```json
POST /order_records/_update/123
{
    "doc": {
        "status": "finished"
    }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929215020.png)​

#### 删除文档

```json
DELETE /order_records/_doc/123
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929215118.png)​

#### 查看文档

```json
GET /order_records/_doc/123
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929215137.png)​

#### 批量导入

```json
POST /_bulk
{ "index": { "_index": "order_records", "_id": "OR001" } }
{ "order_id": "OR001", "customer_id": "C001", "order_date": "2024-01-10", "status": "completed", "total_amount": 150.75, "items": [{ "product_id": "P001", "quantity": 2, "price": 50.00 }, { "product_id": "P002", "quantity": 1, "price": 50.75 }], "shipping_address": "123 Main St, Anytown, USA", "payment_method": "credit_card", "shipping_date": "2024-01-11", "delivery_date": "2024-01-15" }
{ "index": { "_index": "order_records", "_id": "OR002" } }
{ "order_id": "OR002", "customer_id": "C002", "order_date": "2024-01-15", "status": "pending", "total_amount": 89.99, "items": [{ "product_id": "P003", "quantity": 1, "price": 89.99 }], "shipping_address": "456 Elm St, Othertown, USA", "payment_method": "paypal", "shipping_date": "2024-01-16", "delivery_date": "2024-01-20" }
{ "index": { "_index": "order_records", "_id": "OR003" } }
{ "order_id": "OR003", "customer_id": "C003", "order_date": "2024-01-20", "status": "shipped", "total_amount": 120.50, "items": [{ "product_id": "P004", "quantity": 3, "price": 40.00 }], "shipping_address": "789 Maple Ave, Sometown, USA", "payment_method": "debit_card", "shipping_date": "2024-01-21", "delivery_date": "2024-01-25" }
{ "index": { "_index": "order_records", "_id": "OR004" } }
{ "order_id": "OR004", "customer_id": "C004", "order_date": "2024-01-25", "status": "completed", "total_amount": 75.00, "items": [{ "product_id": "P005", "quantity": 5, "price": 15.00 }], "shipping_address": "101 Oak St, Anycity, USA", "payment_method": "credit_card", "shipping_date": "2024-01-26", "delivery_date": "2024-01-30" }
{ "index": { "_index": "order_records", "_id": "OR005" } }
{ "order_id": "OR005", "customer_id": "C005", "order_date": "2024-02-01", "status": "cancelled", "total_amount": 200.00, "items": [{ "product_id": "P006", "quantity": 2, "price": 100.00 }], "shipping_address": "202 Pine St, Otherville, USA", "payment_method": "bank_transfer", "shipping_date": "2024-02-02", "delivery_date": "2024-02-06" }
{ "index": { "_index": "order_records", "_id": "OR006" } }
{ "order_id": "OR006", "customer_id": "C006", "order_date": "2024-02-05", "status": "completed", "total_amount": 300.25, "items": [{ "product_id": "P007", "quantity": 1, "price": 300.25 }], "shipping_address": "303 Cedar Rd, Newtown, USA", "payment_method": "credit_card", "shipping_date": "2024-02-06", "delivery_date": "2024-02-10" }
{ "index": { "_index": "order_records", "_id": "OR007" } }
{ "order_id": "OR007", "customer_id": "C007", "order_date": "2024-02-10", "status": "pending", "total_amount": 45.99, "items": [{ "product_id": "P008", "quantity": 3, "price": 15.33 }], "shipping_address": "404 Birch Ln, Oldtown, USA", "payment_method": "paypal", "shipping_date": "2024-02-11", "delivery_date": "2024-02-15" }
{ "index": { "_index": "order_records", "_id": "OR008" } }
{ "order_id": "OR008", "customer_id": "C008", "order_date": "2024-02-15", "status": "shipped", "total_amount": 89.50, "items": [{ "product_id": "P009", "quantity": 2, "price": 44.75 }], "shipping_address": "505 Spruce St, Littletown, USA", "payment_method": "debit_card", "shipping_date": "2024-02-16", "delivery_date": "2024-02-20" }
{ "index": { "_index": "order_records", "_id": "OR009" } }
{ "order_id": "OR009", "customer_id": "C009", "order_date": "2024-02-20", "status": "completed", "total_amount": 60.00, "items": [{ "product_id": "P010", "quantity": 4, "price": 15.00 }], "shipping_address": "606 Willow Ave, Bigcity, USA", "payment_method": "credit_card", "shipping_date": "2024-02-21", "delivery_date": "2024-02-25" }
{ "index": { "_index": "order_records", "_id": "OR010" } }
{ "order_id": "OR010", "customer_id": "C010", "order_date": "2024-02-25", "status": "cancelled", "total_amount": 150.00, "items": [{ "product_id": "P011", "quantity": 10, "price": 15.00 }], "shipping_address": "707 Poplar Dr, Smalltown, USA", "payment_method": "bank_transfer", "shipping_date": "2024-02-26", "delivery_date": "2024-03-01" }
{ "index": { "_index": "order_records", "_id": "OR011" } }
{ "order_id": "OR011", "customer_id": "C011", "order_date": "2024-03-01", "status": "completed", "total_amount": 110.00, "items": [{ "product_id": "P012", "quantity": 2, "price": 55.00 }], "shipping_address": "808 Chestnut Blvd, Metropolis, USA", "payment_method": "credit_card", "shipping_date": "2024-03-02", "delivery_date": "2024-03-06" }
{ "index": { "_index": "order_records", "_id": "OR012" } }
{ "order_id": "OR012", "customer_id": "C012", "order_date": "2024-03-05", "status": "pending", "total_amount": 75.99, "items": [{ "product_id": "P013", "quantity": 3, "price": 25.33 }], "shipping_address": "909 Ash Ct, Villagetown, USA", "payment_method": "paypal", "shipping_date": "2024-03-06", "delivery_date": "2024-03-10" }
{ "index": { "_index": "order_records", "_id": "OR013" } }
{ "order_id": "OR013", "customer_id": "C013", "order_date": "2024-03-10", "status": "shipped", "total_amount": 200.00, "items": [{ "product_id": "P014", "quantity": 4, "price": 50.00 }], "shipping_address": "1010 Fir Ln, Hamlet, USA", "payment_method": "debit_card", "shipping_date": "2024-03-11", "delivery_date": "2024-03-15" }
{ "index": { "_index": "order_records", "_id": "OR014" } }
{ "order_id": "OR014", "customer_id": "C014", "order_date": "2024-03-15", "status": "completed", "total_amount": 90.00, "items": [{ "product_id": "P015", "quantity": 6, "price": 15.00 }], "shipping_address": "1111 Cypress St, Township, USA", "payment_method": "credit_card", "shipping_date": "2024-03-16", "delivery_date": "2024-03-20" }
{ "index": { "_index": "order_records", "_id": "OR015" } }
{ "order_id": "OR015", "customer_id": "C015", "order_date": "2024-03-20", "status": "cancelled", "total_amount": 135.00, "items": [{ "product_id": "P016", "quantity": 9, "price": 15.00 }], "shipping_address": "1212 Redwood Rd, Cityville, USA", "payment_method": "bank_transfer", "shipping_date": "2024-03-21", "delivery_date": "2024-03-25" }
{ "index": { "_index": "order_records", "_id": "OR016" } }
{ "order_id": "OR016", "customer_id": "C016", "order_date": "2024-03-25", "status": "completed", "total_amount": 250.00, "items": [{ "product_id": "P017", "quantity": 5, "price": 50.00 }], "shipping_address": "1313 Cherry Ave, Urbantown, USA", "payment_method": "credit_card", "shipping_date": "2024-03-26", "delivery_date": "2024-03-30" }
{ "index": { "_index": "order_records", "_id": "OR017" } }
{ "order_id": "OR017", "customer_id": "C017", "order_date": "2024-03-30", "status": "pending", "total_amount": 60.00, "items": [{ "product_id": "P018", "quantity": 2, "price": 30.00 }], "shipping_address": "1414 Beech St, Suburbia, USA", "payment_method": "paypal", "shipping_date": "2024-03-31", "delivery_date": "2024-04-04" }
{ "index": { "_index": "order_records", "_id": "OR018" } }
{ "order_id": "OR018", "customer_id": "C018", "order_date": "2024-04-04", "status": "shipped", "total_amount": 100.00, "items": [{ "product_id": "P019", "quantity": 4, "price": 25.00 }], "shipping_address": "1515 Palm Dr, Downtown, USA", "payment_method": "debit_card", "shipping_date": "2024-04-05", "delivery_date": "2024-04-09" }
{ "index": { "_index": "order_records", "_id": "OR019" } }
{ "order_id": "OR019", "customer_id": "C019", "order_date": "2024-04-09", "status": "completed", "total_amount": 180.00, "items": [{ "product_id": "P020", "quantity": 6, "price": 30.00 }], "shipping_address": "1616 Pine St, Uptown, USA", "payment_method": "credit_card", "shipping_date": "2024-04-10", "delivery_date": "2024-04-14" }
{ "index": { "_index": "order_records", "_id": "OR020" } }
{ "order_id": "OR020", "customer_id": "C020", "order_date": "2024-04-14", "status": "cancelled", "total_amount": 220.00, "items": [{ "product_id": "P021", "quantity": 11, "price": 20.00 }], "shipping_address": "1717 Maple Ave, Seaside, USA", "payment_method": "bank_transfer", "shipping_date": "2024-04-15", "delivery_date": "2024-04-19" }

```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929215222.png)​

## `Elasticsearch`​ 高级查询与DSL训练

> 要求： 完成练习题
>
> 任务三：
>
> 1. 用户信息数据
> 2. 产品目录数据
> 3. 订单记录数据

### 用户信息数据

**查询所有女性用户的姓名和电子邮件**

```json
GET /user_information/_search
{
  "_source": ["name", "email"],
  "query": {
    "term": {
      "gender": "female"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929220712.png)​

**查找最后登录日期在2024年9月1日之后的所有活跃用户**

```json
GET /user_information/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "range": {
            "last_login": {
              "gt": "2024-09-01"
            }
          }
        },
        {
          "term": {
            "status": "active"
          }
        }
      ]
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929220756.png)​

**查询住在&quot;Anytown&quot;的用户**

```json
GET /user_information/_search
{
  "query": {
    "match": {
      "address": "Anytown"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929220916.png)​

**查找出生日期在1990年之后的所有用户**

```json
GET /user_information/_search
{
  "query": {
    "range": {
      "date_of_birth": { "gt": "1990-01-01" }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929223033.png)​

**查询所有状态为&quot;inactive&quot;的用户**

```json
GET /user_information/_search
{
  "query": {
    "term": {
      "status": "inactive"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929223012.png)​

**查找注册日期在2023年1月1日到2023年12月31日之间的用户**

```json
GET /user_information/_search
{
  "query": {
    "range": {
      "registration_date": {
        "gte": "2023-01-01",
        "lte": "2023-12-31"
      }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222951.png)​

**查询名字为&quot;Bob Smith&quot;的用户的详细信息**

```json
GET /user_information/_search
{
  "query": {
    "match": {
      "name": "Bob Smith"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222933.png)​

**查找电话号码以&quot;123&quot;开头的用户**

```json
GET /user_information/_search
{
  "query": {
    "prefix": {
      "phone_number": "123"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222915.png)​

**查询电子邮件域为&quot;example.com&quot;的所有用户**

```json
GET /user_information/_search
{
  "query": {
    "wildcard": {
      "email": "*@example.com"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222850.png)​

**查找所有名字中包含&quot;Lee&quot;的用户**

```json
GET /user_information/_search
{
  "query": {
    "match": {
      "name": "Lee"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222832.png)​

### 产品目录数据

**查询所有类别为&quot;Audio&quot;的产品名称和价格**

```json
GET /product_catalog/_search
{
  "_source": ["name", "price"],
  "query": {
    "term": {
      "category": "Audio"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222807.png)​

**查找价格高于50美元的所有产品**

```json
GET /product_catalog/_search
{
  "query": {
    "range": {
      "price": { "gt": 50 }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222743.png)​

**查询库存数量少于100的产品**

```json
GET /product_catalog/_search
{
  "query": {
    "range": {
      "stock_quantity": { "lt": 100 }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222726.png)​

**查找评分高于4.5的所有产品**

```json
GET /product_catalog/_search
{
  "query": {
    "range": {
      "rating": { "gt": 4.5 }
    }
  }
}

```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222708.png)​

**查询标签中包含&quot;smart&quot;的所有产品**

```json
GET /product_catalog/_search
{
  "query": {
    "term": {
      "tags": "smart"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222651.png)​

**查找供应商为&quot;TechCorp&quot;的产品**

```json
GET /product_catalog/_search
{
  "query": {
    "term": {
      "supplier": "TechCorp"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222632.png)​

**查询发布日期在2023年6月1日之后的所有产品**

```json
GET /product_catalog/_search
{
  "query": {
    "range": {
      "release_date": { "gt": "2023-06-01" }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222613.png)​

**查找描述中包含&quot;wireless&quot;的产品**

```json
GET /product_catalog/_search
{
  "query": {
    "match": {
      "description": "wireless"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222553.png)​

**查询价格在20美元到100美元之间的所有产品**

```json
GET /product_catalog/_search
{
  "query": {
    "range": {
      "price": { "gte": 20, "lte": 100 }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222532.png)​

**查找产品名称中包含&quot;Light&quot;的所有产品**

```json
GET /product_catalog/_search
{
  "query": {
    "match": {
      "name": "Light"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222510.png)​

### 订单记录数据

**查询所有状态为&quot;completed&quot;的订单的订单ID和总金额**

```json
GET /order_records/_search
{
  "_source": ["order_id", "total_amount"],
  "query": {
    "term": {
      "status": "completed"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222435.png)​

**查找总金额大于100美元的所有订单**

```json
GET /order_records/_search
{
  "query": {
    "range": {
      "total_amount": { "gt": 100 }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222414.png)​

**查询支付方式为&quot;paypal&quot;的订单**

```json
GET /order_records/_search
{
  "query": {
    "term": {
      "payment_method": "paypal"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222348.png)​

**查找订单日期在2024年2月之后的所有订单**

```json
GET /order_records/_search
{
  "query": {
    "range": {
      "order_date": { "gt": "2024-02-01" }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222321.png)​

**查询包含产品ID为&quot;P001&quot;的订单**

```json
GET /order_records/_search
{
  "query": {
    "nested": {
      "path": "items",
      "query": {
        "bool": {
          "must": [
            { "term": { "items.product_id": "P001" } }
          ]
        }
      }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929222249.png)​

**查找所有状态为&quot;cancelled&quot;的订单的客户ID**

```json
GET /order_records/_search
{
  "_source": ["customer_id"],
  "query": {
    "term": {
      "status": "cancelled"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929221638.png)​

**查询发货日期在2024年1月15日之前的订单**

```json
GET /order_records/_search
{
  "query": {
    "range": {
      "shipping_date": { "lt": "2024-01-15" }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929221607.png)​

**查找使用&quot;credit_card&quot;支付的订单**

```json
GET /order_records/_search
{
  "query": {
    "term": {
      "payment_method": "credit_card"
    }
  }
}

```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929221537.png)​

**查询总金额在50美元到200美元之间的所有订单**

```json
GET /order_records/_search
{
  "query": {
    "range": {
      "total_amount": { "gte": 50, "lte": 200 }
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929221456.png)​

**查找订单ID中包含&quot;OR01&quot;的所有订单**

```json
GET /order_records/_search
{
  "query": {
    "wildcard": {
      "order_id": "OR01*"
    }
  }
}
```

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929221409.png)​

# 三、问题以及解决方法

## 1、由于更换环境，安装Docker形式的ES过程中出现问题。

**例如：**

1. ​`es`​ 在容器里面不用 `root`​ 用户运行，挂载数据的时候出现读取异常
2. ​`es`​ 默认使用 `https`​，最开始没有修改配置文件
3. 配置文件取消es,仅设置 `enable`​ 为 `false`​ 会报错

**解决办法：**

1. 权限异常修复

修改挂载的目录和文件的权限

```shell
chmod g+wxr 目录
chgrp 0 目录

# 意思是：给目录所属的 GID 为 0 的文件 读、写、执行 的权限
```

修改 `Docker`​ 启动命令

```shell
# docker run 添加
--group-add 0
```

2. ​`https`​ 配置文件修改

不能仅把 `enable`​ 设置为 `false`​，将涉及到的配置项全部注释。下面是修改后的配置文件：

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929204210.png)​

‍

## 2、Ik分词器无法正常使用

**这是报错：**

​![image](https://raw.githubusercontent.com/tecwds/picgo-repo/bucket/20240929210329.png)​

**猜测原因：**

1. ​`es`​ 版本太高
2. ​`docker`​ 环境特有的报错（因为之前 `win（wsl2）`​ 上没有错误）

**解决办法：**

1. 在 `Github`​ 下载官方已经做好的包
2. 解压
3. 复制官方 `config`​ 目录到 `<es>/plugins/analysis-ik/config`​
4. 重启 `es`​
5. ok

## 3、Apifox 批量导入问题

**解决办法：**

在 `json`​ 最后一行加一个空行。

‍

## 4、嵌套询的问题

**错误信息：**

```json
{
  "error": {
    "root_cause": [
      {
        "type": "query_shard_exception",
        "reason": "failed to create query: [nested] failed to find nested object under path [items]",
        "index_uuid": "do6XIleXR-CKBkguQTRVdQ",
        "index": "order_records"
      }
    ],
    "type": "search_phase_execution_exception",
    "reason": "all shards failed",
    "phase": "query",
    "grouped": true,
    "failed_shards": [
      {
        "shard": 0,
        "index": "order_records",
        "node": "WaByeACrTwu49GsMngUNrw",
        "reason": {
          "type": "query_shard_exception",
          "reason": "failed to create query: [nested] failed to find nested object under path [items]",
          "index_uuid": "do6XIleXR-CKBkguQTRVdQ",
          "index": "order_records",
          "caused_by": {
            "type": "illegal_state_exception",
            "reason": "[nested] failed to find nested object under path [items]"
          }
        }
      }
    ]
  },
  "status": 400
}
```

**错误描述：**

嵌套查询出错

**解决办法：**

```json
{
  "order_records": {
    "mappings": {
      "properties": {
        "items": {
          "type": "nested",
          "properties": {
            "product_id": {
              "type": "keyword"
            },
            // 其他字段...
          }
        },
        // 其他字段...
      }
    }
  }
}

```

修改索引，添加 `"type": "nested"`​。成功！
